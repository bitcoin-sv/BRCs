# BRC-80 - Solicited & Unsolicted Payment Flows with Mutual Auth

Deggen (d.kellenschwiler@bsvblockchain.org)

## Abstract

Thinking about how to avoid paying to outputs which an attacker has created, when communicating with a counterparty via hosted service discovery mechanisms. Ensuring we are able to determine counterparties in payments where the counterparties both sign off, and also when a pre-validation has occurred such that no further authorization is necessary from the receiving side.

## Motivation

Paymail p2p destinations and receive-rawtx are used today and there remains a security and privacy issue. For now it’s not proven that the outputs received are correct, and linked to the payee. It’s also not specified whether overpayment is allowed and so forth.


## Specification

Let’s see if we can define the flow in a diagram.

```mermaid
sequenceDiagram
    box rgb(25,15,25) Alice
    actor AC as Alice's Phone
    participant ABUX as Alice's BUX
    end
    box rgb(25,35,45) Bob
    participant BBUX as Bob's BUX
    actor BC as Bob's Phone
    end
    AC ->> BBUX: Lookup Bob's pki
    BBUX -->> AC: pubkey
    AC ->> BBUX: Contact Request
    BBUX -->> AC: Receipt Acknowledged
    BC ->> BBUX: Check Message Box
    BBUX -->> BC: Alice's Contact Request
    BC ->> ABUX: Lookup Alice's pki
    ABUX -->> BC: pubkey
    BC ->> BC: Calculate TOTP using Bob privkey and Alice Pubkey
    BC -->> AC: Send Alice TOTP in person or on a call
    AC ->> AC: Validate TOTP and store trust contact
    AC -> AC: Wait 15 seconds until we have a new TOTP value
    AC ->> AC: Calculate TOTP using Alice privkey and Bob Pubkey
    AC -->> BC: Send Bob TOTP in person or on a call 
    BC ->> BC: Validate TOTP and store tust contact
    
    AC ->> AC: Alice wants to pay Bob, she calculates derived keys
    AC ->> BBUX: Payment Request (beef, senderPubkey, inv)
    BBUX ->> BBUX: SPV checks
    BBUX -->> AC: Receipt Acknowledged
    BC ->> BBUX: Check Message Box
    BBUX -->> BC: Alice's Payment Request
    BC ->> BC: Calculates amount paid and validates origin.
    BC ->> BBUX: Accept - shares indices of our utxos
    BBUX ->> ARC: Publish Tx
    ARC -->> BBUX: TxStatus SEEN
    BBUX ->> ABUX: Payment Accepted
    ABUX -> ABUX: Update utxos
    ARC -->> BBUX: TxStatus MINED
    BBUX -->> ABUX: BUMP    
```