# BRC-106: Bitcoin Script ASM Format

Freddie Honohan (freddie@yenpoint.jp)

## Abstract

This proposal introduces a standardised method of dealing with the ASM representation of Bitcoin Script across the ecosystem language libraries (Py-SDK, TS-SDK, Go-SDK, Teranode etc).

## Motivation

The purpose of this proposal is to provide a generalised standard in order for deterministic translation of Bitcoin Script to and from ASM for cross-language compatibility.

Currently, different implementations may produce inconsistent ASM representations for the same script. For example, the boolean value `false` might be rendered as `OP_0`, `OP_FALSE` depending on the library used. This lack of standardisation creates interoperability issues when scripts are shared across different tools and platforms.

## Specification

1. It is important that ASM format scripts operate correctly regardless of where they were produced or processed.

2. The Hexadecimal and Binary representations are defined in BRC-14.

3. Since ASM format is primarily used for human-readability, op-codes with multiple representations like the boolean pair `[OP_0, OP_1]` are to be represented as their english full-name counterpart e.g. `[OP_FALSE, OP_TRUE]`

   **Example:**
```
   Hex:  0x00 0x51
   ASM:  OP_FALSE OP_TRUE
   Not:  OP_0 OP_1
```

4. Other discrepancies were found and documented [here](https://docs.google.com/spreadsheets/d/106aSWsOeNayzXOU9tRmRIvSu2Cz21YZQ5uCrwMZg1WU/) and rules are set out below to deal with them.

## Implementation

### General Principles

1. The logic dealing with Bitcoin Script ASM is to be standardised across libraries and languages as described hereunder.

2. Op-Codes with several names must be parsed into the correct hex/binary byte despite the chosen ASM format name.

   **Example Input Parsing:**
```javascript
   // All of these should parse to 0x00
   parseASM("OP_0")      // ✓ valid
   parseASM("OP_FALSE")  // ✓ valid
   
   // Both should output the same hex
   parseASM("OP_0") === parseASM("OP_FALSE")  // true
```

3. However op-codes with several names must be output into the most human-readable format (e.g. `OP_0` will always output as `OP_FALSE`).

   **Example Output Serialization:**
```javascript
   // Input hex, always outputs human-readable form
   toASM(0x00)  // "OP_FALSE" (not "OP_0")
   toASM(0x51)  // "OP_TRUE"  (not "OP_1")
```

### Push Data Operations

4. `OP_PUSHDATA1` should always convert to `0x4c` and vice-versa.

   **Example:**
```
   ASM → Hex:  OP_PUSHDATA1 → 0x4c
   Hex → ASM:  0x4c → OP_PUSHDATA1
```

5. `OP_PUSHDATA2` should always convert to `0x4d` and vice-versa.

   **Example:**
```
   ASM → Hex:  OP_PUSHDATA2 → 0x4d
   Hex → ASM:  0x4d → OP_PUSHDATA2
```

6. `OP_PUSHDATA4` should always convert to `0x4e` and vice-versa.

   **Example:**
```
   ASM → Hex:  OP_PUSHDATA4 → 0x4e
   Hex → ASM:  0x4e → OP_PUSHDATA4
```

### Data Manipulation Operations

7. `OP_SPLIT` should always convert to `0x7f` and vice-versa.

   **Example:**
```
   ASM → Hex:  OP_SPLIT → 0x7f
   Hex → ASM:  0x7f → OP_SPLIT
```

8. `OP_NUM2BIN` should always convert to `0x80` and vice-versa.

   **Example:**
```
   ASM → Hex:  OP_NUM2BIN → 0x80
   Hex → ASM:  0x80 → OP_NUM2BIN
```

9. `OP_BIN2NUM` should always convert to `0x81` and vice-versa.

   **Example:**
```
   ASM → Hex:  OP_BIN2NUM → 0x81
   Hex → ASM:  0x81 → OP_BIN2NUM
```

### Obsolete Operations

10. Replaced legacy op-codes (`OP_SUBSTR`, `OP_LEFT`, `OP_RIGHT`) ought not to be parsable and throw an error.

    **Example Error Handling:**
```typescript
    // Should throw error
    Script.fromAsm("OP_SUBSTR")  // Error: OP_SUBSTR was replaced by OP_SPLIT
    Script.fromAsm("OP_LEFT")    // Error: OP_LEFT was replaced by OP_NUM2BIN
    Script.fromAsm("OP_RIGHT")   // Error: OP_RIGHT was replaced by OP_BIN2NUM
```

## References

- <a name="footnote-1">[BRC-14](./0014.md)</a>: Bitcoin Script Binary and Hex Formats - Ty Everett (ty@projectbabbage.com)